/*
 * Copyright Â© 2017-2017 Elton Santos Vianna. Distributed under GNU General Public License v3.0.
 */ var wellcomeMessages={},noteTimeout,gameOver=!1,gameMode=0,computerGameId={},maxScore={},modal={},bundle={},stringFormat=(a,b)=>{for(var c=a,d=b?b.length:0;d--;)c=c.replace(new RegExp('\\{'+d+'\\}','gm'),b[d]);return c},setLang=a=>{jQuery.i18n.properties({name:'messages',path:'bundle/',mode:'both',language:a,callback:()=>{bundle=$.i18n.prop}});for(var d,b=$('[bundle]'),c=b.length;c--;)d=b[c],!d||(d.innerHTML=resourceBundle(d.getAttribute('bundle')))},resourceBundle=(a,b)=>{if(!!a){var c=bundle(a);return!c?a:c.match(/{[0-9]+}/g)&&b?stringFormat(c,b):c}return'null'},randomWellcomeMessage=a=>{return resourceBundle('wellcome_message_'+Math.floor(Math.random()*a))},gameCallback=a=>{var b=resourceBundle('weapon_'+a.weapon),c=resourceBundle('resultCode_'+a.resultCode,[b]);showNote(c,a.result,noteTimeout);try{updateScores(a)}catch(g){gameOver=!0,'1'===a.mode&&stopComputerGame();var d=selectWinner(JSON.parse(g)),f=selectResultMessage(d,a.mode);showModal(!0,f,d)}},updateScores=a=>{switch(parseInt(a.result)){case 1:incrementScore(['score1']);break;case-1:incrementScore(['score2']);break;case 0:incrementScore(['score1','score2']);}},selectResultMessage=(a,b)=>{if(0===a)return resourceBundle('game.tied',[resourceBundle('game.over')]);if('0'===b)return resourceBundle(1===a?'you.win':'you.lose',[resourceBundle('game.over')]);var c=1===a?1:2;return resourceBundle('player.win',[c,resourceBundle('game.over')])},selectWinner=a=>{return 2==a.length?0:'score1'===a[0]?1:-1},configurationCallback=a=>{!a||(maxScore=a.maxScore,noteTimeout=a.noteTimeout,wellcomeMessages=parseInt(a.wellcomeMessages),$('#maxScoreValue').html(maxScore))},errorCallback=a=>{4==a.readyState&&(500<=a.status?showNote(resourceBundle('error.server'),500,noteTimeout):400<=a.status&&500>a.status?showNote(resourceBundle('error.resources'),0):showNote(resourceBundle('error.connection'),500,noteTimeout))},showModal=(a,b,c)=>{modal.style.display=!0==a?'block':'none',!b||setTimeout(()=>{showNote(b,c,1e5)},noteTimeout)},closeNote=()=>{var a=document.getElementById('note');!a||(a.style.visibility='hidden')},showNote=(a,b,c)=>{var d=document.getElementById('note');!d||(d.className=selectClass(b),d.innerHTML=a,d.style.display='block',setTimeout(()=>{d.style.display='none'},c))},selectClass=a=>{var b=null;switch(parseInt(a)){case 1:b='note-success';break;case 0:b='note-info';break;case-1:b='note-warning';break;case 500:b='note-danger';}return b},startGame=()=>{showNote(randomWellcomeMessage(1),1,2e3),getJson('/rest/configuration',configurationCallback,errorCallback);var a=document.getElementById('weapons');!a||a.addEventListener('click',d=>{if('IMG'===d.target.tagName){if(!0==gameOver||0<computerGameId)return void d.preventDefault();getJson('/rest/'+d.target.id,gameCallback,errorCallback)}});var b=document.getElementById('buttons');!b||b.addEventListener('click',d=>{if('BUTTON'===d.target.tagName){var f='0'===d.target.id?'1':'0';swapClass(f,d.target.id,'disabled','active'),newGame(d.target.id)}});var c=document.getElementById('languages');!c||c.addEventListener('click',d=>{'IMG'===d.target.tagName&&setLang(d.target.id)}),modal=document.getElementById('rps-modal')},startComputerGame=()=>{computerGameId=window.setInterval(()=>{getJson('/rest/computer',gameCallback,errorCallback)},eval(1.5*noteTimeout))},stopComputerGame=()=>{!computerGameId||(window.clearInterval(computerGameId),computerGameId=0)},newGame=a=>{gameMode=a,stopComputerGame(),update('name1',resourceBundle('page.player1_'+a)),update('name2',resourceBundle('page.player2_'+a)),'1'===a?replaceClass(['rock','paper','scissors'],'fade','disabled'):replaceClass(['rock','paper','scissors'],'disabled','fade'),resetScores(['score1','score2']),showModal(!1,null),showNote(randomWellcomeMessage(wellcomeMessages),1,noteTimeout),gameOver=!1,'1'===a&&startComputerGame()},resetScores=a=>{!a||a.forEach(b=>{update(b,0)})},incrementScore=a=>{if(!!a){var b=[];if(a.forEach(c=>{var d=document.getElementById(c);if(!!d){var f=parseInt(d.innerHTML)+1;d.innerHTML=f,f>=maxScore&&b.push(c)}}),0<b.length)throw JSON.stringify(b)}},update=(a,b)=>{if(!!a){var c=document.getElementById(a);!c||(c.innerHTML=b)}},swapClass=(a,b,c,d)=>{removeClass([a],d),removeClass([b],c),addClass([a],c),addClass([b],d)},addClass=(a,b)=>{replaceClass(a,null,b)},removeClass=(a,b)=>{replaceClass(a,b,null)},replaceClass=(a,b,c)=>{!a||a.forEach(d=>{!b||$('#'+d).removeClass(b),!c||$('#'+d).addClass(c)})},get=(a,b,c,d)=>{var f=new XMLHttpRequest;f.onreadystatechange=()=>{4==f.readyState&&200==f.status?c(JSON.parse(f.responseText)):d(f)},f.open('GET',a,!0),f.setRequestHeader('Accept',b),f.send(null)},getJson=(a,b,c)=>{get(a,'application/json',b,c)},disableRefresh=a=>{return 116!=(a.which||a.keyCode)&&65==a.keyCode&&a.ctrlKey};window.onbeforeunload=()=>{return resourceBundle('game.data.lost')},(a=>{document.onkeydown=b=>{return disableRefresh(b)},a(()=>{setLang(document.documentElement.lang),startGame()})})(jQuery);